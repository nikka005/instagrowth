# ================================================================
# InstaGrowth OS - Quick Copy-Paste Commands
# GitHub: https://github.com/nikka005/instagrowth.git
# Domain: instagrowth.io
# ================================================================

# ===========================================
# COPY AND PASTE THESE COMMANDS ONE BY ONE
# ===========================================

# ----- 1. UPDATE SYSTEM -----
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl wget git vim htop unzip software-properties-common

# ----- 2. INSTALL NODE.JS 20 -----
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs
sudo npm install -g yarn pm2

# ----- 3. INSTALL PYTHON 3.11 -----
sudo add-apt-repository ppa:deadsnakes/ppa -y
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3.11-dev python3-pip

# ----- 4. INSTALL MONGODB 7.0 -----
curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
sudo apt update
sudo apt install -y mongodb-org
sudo systemctl start mongod
sudo systemctl enable mongod

# ----- 5. INSTALL NGINX -----
sudo apt install -y nginx certbot python3-certbot-nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# ----- 6. CLONE YOUR REPO -----
sudo mkdir -p /var/www/instagrowth
sudo chown -R $USER:$USER /var/www/instagrowth
cd /var/www/instagrowth
git clone https://github.com/nikka005/instagrowth.git .

# ----- 7. SETUP BACKEND -----
cd /var/www/instagrowth/backend
python3.11 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
pip install emergentintegrations --extra-index-url https://d33sy5i8bnduwe.cloudfront.net/simple/

# ----- 8. CREATE BACKEND .ENV -----
cat > /var/www/instagrowth/backend/.env << 'EOF'
MONGO_URL=mongodb://localhost:27017
DB_NAME=instagrowth_db
JWT_SECRET=change-this-to-a-very-long-secret-key-minimum-32-chars
ADMIN_SECRET_CODE=INSTAGROWTH_ADMIN_2024
OPENAI_API_KEY=your-openai-key
RESEND_API_KEY=your-resend-key
SENDER_EMAIL=noreply@instagrowth.io
FRONTEND_URL=https://instagrowth.io
EOF

# ----- 9. SETUP FRONTEND -----
cd /var/www/instagrowth/frontend
yarn install

cat > /var/www/instagrowth/frontend/.env << 'EOF'
REACT_APP_BACKEND_URL=https://instagrowth.io
GENERATE_SOURCEMAP=false
EOF

yarn build

# ----- 10. CONFIGURE NGINX -----
sudo tee /etc/nginx/sites-available/instagrowth > /dev/null << 'NGINX'
server {
    listen 80;
    server_name instagrowth.io www.instagrowth.io;
    
    root /var/www/instagrowth/frontend/build;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
    }

    gzip on;
    gzip_types text/plain text/css application/json application/javascript;
}
NGINX

sudo ln -sf /etc/nginx/sites-available/instagrowth /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl reload nginx

# ----- 11. SETUP PM2 -----
cat > /var/www/instagrowth/ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'instagrowth-backend',
    cwd: '/var/www/instagrowth/backend',
    script: 'venv/bin/uvicorn',
    args: 'server:app --host 0.0.0.0 --port 8001 --workers 4',
    interpreter: 'none',
    autorestart: true,
  }]
};
EOF

cd /var/www/instagrowth
pm2 start ecosystem.config.js
pm2 save
pm2 startup systemd

# ----- 12. SSL CERTIFICATE -----
# First point DNS to your server IP, then run:
sudo certbot --nginx -d instagrowth.io -d www.instagrowth.io


# ===========================================
# DNS SETTINGS (At your domain registrar)
# ===========================================
# Type: A    Name: @      Value: YOUR_EC2_IP
# Type: A    Name: www    Value: YOUR_EC2_IP


# ===========================================
# DAILY COMMANDS
# ===========================================

# Check status
pm2 status

# View logs
pm2 logs instagrowth-backend

# Restart backend
pm2 restart instagrowth-backend

# Restart nginx
sudo systemctl reload nginx


# ===========================================
# UPDATE/DEPLOY NEW CODE
# ===========================================

cd /var/www/instagrowth
git pull origin main

# Update backend
cd /var/www/instagrowth/backend
source venv/bin/activate
pip install -r requirements.txt

# Update frontend
cd /var/www/instagrowth/frontend
yarn install
yarn build

# Restart
pm2 restart instagrowth-backend
sudo systemctl reload nginx


# ===========================================
# TROUBLESHOOTING
# ===========================================

# Check backend logs
pm2 logs instagrowth-backend --lines 100

# Check nginx logs
sudo tail -f /var/log/nginx/error.log

# Check MongoDB
sudo systemctl status mongod

# Check if ports are open
sudo lsof -i :80
sudo lsof -i :8001


# ===========================================
# ACCESS YOUR APP
# ===========================================
# Website: https://instagrowth.io
# Admin: https://instagrowth.io/admin-panel/login
# 
# Admin Login:
#   Email: superadmin@instagrowth.com
#   Password: SuperAdmin123!
#   Code: INSTAGROWTH_ADMIN_2024
